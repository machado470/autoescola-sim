generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  ADMIN
}

model User {
  id               String             @id @default(uuid())
  name             String
  email            String             @unique
  passwordHash     String
  role             UserRole           @default(STUDENT)
  xp               Int                @default(0)
  refreshTokenHash String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  quizSessions     QuizSession[]
  progress         StudentProgress[]
  attempts         SimuladoAttempt[]
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  phases      Phase[]
  questions   Question[]
  lessons     Lesson[]
}

model Phase {
  id         String     @id @default(uuid())
  name       String
  order      Int
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  categoryId String
  category   Category   @relation(fields: [categoryId], references: [id])

  questions    Question[]
  lessons      Lesson[]
  progress     StudentProgress[]
  quizSessions QuizSession[]

  @@unique([categoryId, name], name: "categoryId_name")
}

model Lesson {
  id         String     @id @default(uuid())
  title      String
  content    String?
  order      Int        @default(0)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  categoryId String
  category   Category   @relation(fields: [categoryId], references: [id])

  phaseId    String
  phase      Phase      @relation(fields: [phaseId], references: [id])

  @@unique([categoryId, title], name: "categoryId_title")
}

model Question {
  id         String          @id @default(uuid())
  statement  String
  optionA    String
  optionB    String
  optionC    String
  optionD    String
  correct    String
  order      Int             @default(0)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  categoryId String
  category   Category        @relation(fields: [categoryId], references: [id])

  phaseId    String
  phase      Phase           @relation(fields: [phaseId], references: [id])

  answers    SimuladoAnswer[]

  @@unique([categoryId, statement], name: "categoryId_statement")
}

model QuizSession {
  id         String     @id @default(uuid())
  userId     String
  phaseId    String
  score      Int        @default(0)

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  user       User       @relation(fields: [userId], references: [id])
  phase      Phase      @relation(fields: [phaseId], references: [id])
}

model StudentProgress {
  id               String     @id @default(uuid())
  userId           String
  phaseId          String
  lessonsCompleted Int        @default(0)
  correctAnswers   Int        @default(0)
  finished         Boolean    @default(false)

  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  user             User       @relation(fields: [userId], references: [id])
  phase            Phase      @relation(fields: [phaseId], references: [id])

  @@unique([userId, phaseId], name: "userId_phaseId")
}

//
// --------------------------
// SIMULADO
// --------------------------
//

model SimuladoAttempt {
  id             String           @id @default(cuid())
  userId         String
  type           String
  totalQuestions Int
  createdAt      DateTime         @default(now())

  user     User              @relation(fields: [userId], references: [id])
  answers  SimuladoAnswer[]
}

model SimuladoAnswer {
  id         String           @id @default(cuid())
  attemptId  String
  questionId String
  selected   Int
  correct    Boolean

  attempt    SimuladoAttempt  @relation(fields: [attemptId], references: [id])
  question   Question         @relation(fields: [questionId], references: [id])
}

generator seed {
  provider = "prisma-client-js"
  run      = "tsx prisma/seed.ts"
}
