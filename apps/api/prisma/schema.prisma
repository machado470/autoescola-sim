// -----------------------------------------------------
// Prisma Schema — AutoEscola-Sim (versão final corrigida)
// -----------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------
// ENUMS
// -----------------------------------------------------

enum UserRole {
  STUDENT
  ADMIN
}

// -----------------------------------------------------
// MODELS
// -----------------------------------------------------

model User {
  id               String   @id @default(uuid())
  name             String
  email            String   @unique
  passwordHash     String
  role             UserRole @default(STUDENT)
  xp               Int      @default(0)
  refreshTokenHash String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  quizSessions QuizSession[]
  progress      StudentProgress[]
}

model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  phases    Phase[]
  questions Question[]
  lessons   Lesson[]
}

model Phase {
  id         String   @id @default(uuid())
  name       String
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  questions  Question[]
  lessons    Lesson[]
  progress   StudentProgress[]

  quizSessions QuizSession[]
}

model Lesson {
  id         String   @id @default(uuid())
  title      String
  content    String?
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  phaseId    String
  phase      Phase @relation(fields: [phaseId], references: [id])
}

model Question {
  id         String   @id @default(uuid())
  statement  String
  optionA    String
  optionB    String
  optionC    String
  optionD    String
  correct    String
  order      Int      @default(0)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  phaseId    String
  phase      Phase @relation(fields: [phaseId], references: [id])
}

model QuizSession {
  id         String   @id @default(uuid())
  userId     String
  phaseId    String
  score      Int      @default(0)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User @relation(fields: [userId], references: [id])
  phase      Phase @relation(fields: [phaseId], references: [id])
}

model StudentProgress {
  id               String   @id @default(uuid())
  userId           String
  phaseId          String
  lessonsCompleted Int      @default(0)
  correctAnswers   Int      @default(0)
  finished         Boolean  @default(false)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User  @relation(fields: [userId], references: [id])
  phase            Phase @relation(fields: [phaseId], references: [id])

  @@unique([userId, phaseId])
}

// -----------------------------------------------------
// SEED CONFIG
// -----------------------------------------------------

generator seed {
  provider = "prisma-client-js"
  run      = "tsx prisma/seed.ts"
}
