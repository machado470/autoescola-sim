generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  passwordHash String

  role      Role
  createdAt DateTime @default(now())

  studentProgress StudentProgress[]
  studentLessons  StudentLesson[]
  simulations     Simulation[]

  // Apenas UMA relação com SimuladoAttempt → OK
  attempts        SimuladoAttempt[] @relation("UserAttempts")
}

model Category {
  id    String @id @default(uuid())
  name  String @unique

  phases  Phase[]
  lessons Lesson[]
}

model Phase {
  id         String  @id @default(uuid())
  name       String
  order      Int
  categoryId String

  category  Category @relation(fields: [categoryId], references: [id])
  lessons   Lesson[]
  progress  StudentProgress[]
  questions Question[]
}

model Lesson {
  id       String @id @default(uuid())
  title    String
  order    Int
  content  String
  imageUrl String?
  videoUrl String?

  categoryId String
  phaseId    String

  category Category @relation(fields: [categoryId], references: [id])
  phase    Phase    @relation(fields: [phaseId], references: [id])

  studentLessons StudentLesson[]
}

model StudentLesson {
  id        String   @id @default(uuid())
  userId    String
  lessonId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@unique([userId, lessonId])
}

model StudentProgress {
  id               String   @id @default(uuid())
  userId           String
  phaseId          String
  lessonsCompleted Int
  correctAnswers   Int
  finished         Boolean @default(false)

  user  User  @relation(fields: [userId], references: [id])
  phase Phase @relation(fields: [phaseId], references: [id])

  @@unique([userId, phaseId])
}

model Question {
  id      String @id @default(uuid())
  text    String
  answer  String
  phaseId String

  phase Phase @relation(fields: [phaseId], references: [id])
}

model SimuladoAttempt {
  id         String   @id @default(uuid())
  userId     String
  percentage Int
  createdAt  DateTime @default(now())

  user User @relation("UserAttempts", fields: [userId], references: [id])
}

model Simulation {
  id        String              @id @default(cuid())
  userId    String
  user      User                @relation(fields: [userId], references: [id])
  startedAt DateTime            @default(now())
  finishedAt DateTime?
  answers   SimulationAnswer[]
}

model SimulationAnswer {
  id           String     @id @default(cuid())
  simulationId String
  questionId   String
  selected     String
  correct      Boolean
  createdAt    DateTime   @default(now())

  simulation   Simulation @relation(fields: [simulationId], references: [id])
}

enum Role {
  STUDENT
  ADMIN
}
